/*! ethz-raytracer - v0.0.1 - 2013-10-23
* Copyright (c) 2013 ; Licensed  */
(function(){var a,b,c,d,e,f,g,h,i;a=function(){function a(a,b,c,d,e,f,g){this.position=a,this.direction=b,this.upDirection=c,this.distance=d,this.fieldOfView=e,this.width=f,this.height=g,this.calibrateCamera()}return a.prototype.calibrateCamera=function(){return this.direction=this.direction.toUnitVector(),this.rightDirection=this.direction.cross(this.upDirection).toUnitVector(),this.upDirection=this.rightDirection.cross(this.direction).toUnitVector(),this.imagePaneHeight=2*Math.tan(this.fieldOfView/2)*this.distance,this.imagePaneWidth=this.imagePaneHeight/this.height*this.width,this.imageCenter=this.position.add(this.direction.multiply(this.distance)),this.imageTop=this.imageCenter.add(this.upDirection.multiply(this.imagePaneHeight/2)),this.imageBottom=this.imageCenter.add(this.upDirection.multiply(-1*this.imagePaneHeight/2)),this.imageLeft=this.imageCenter.add(this.rightDirection.multiply(-1*this.imagePaneWidth/2)),this.imageRight=this.imageCenter.add(this.rightDirection.multiply(this.imagePaneWidth/2))},a.prototype.getCenter=function(){return this.position.add(this.direction)},a}(),b=function(){function a(a,b,c){a instanceof Vector&&(b=a.elements[1],c=a.elements[2],a=a.elements[0]),0>a&&(a=0),0>b&&(b=0),0>c&&(c=0),a>1&&(a=1),b>1&&(b=1),c>1&&(c=1),this.val=$V([a,b,c])}return a.random=function(){return new a(Math.random(),Math.random(),Math.random())},a.prototype.add=function(b){return new a(this.val.add(b.val))},a.prototype.multiply=function(b){return new a(this.val.multiply(b))},a.prototype.multiplyColor=function(b){return new a(this.val.elements[0]*b.val.elements[0],this.val.elements[1]*b.val.elements[1],this.val.elements[2]*b.val.elements[2])},a.prototype.toArray=function(){return this.val.dup().elements},a.prototype.toVector=function(){return this.val.dup()},a}(),c=function(){function a(a,b,c){this.color=a,this.location=b,this.intensity=c}return a}(),d=function(){function a(a,b,c){this.ambient=a,this.diffuse=b,this.specular=c}return a}(),this.loadScene=function(){var e,f,j,k;return j=30/180*Math.PI,f=new a($V([0,0,10]),$V([0,0,-1]),$V([0,1,0]),1,j,RayConfig.width,RayConfig.height),k=new h(f,.2),k.addLight(new c(new b(1,1,1),$V([10,10,10]),new d(0,1,1))),ModuleId.ALT?(e=b.random(),k.addObject(new i($V([0,0,0]),2,new g(e,e,new b(1,1,1),32,1.5))),e=b.random(),k.addObject(new i($V([1.25,1.25,3]),.5,new g(e,e,new b(.5,.5,1),16,1.5))),e=b.random(),k.addObject(new i($V([1.25,-1.25,3]),.5,new g(e,e,new b(.5,.5,1),16,1.5))),e=b.random(),k.addObject(new i($V([0,-.75,3]),.5,new g(e,e,new b(.5,.5,1),16,1.5))),k.addObject(new i($V([2.5,0,-1]),.5,new g(new b(0,0,.75),new b(0,0,1),new b(.5,.5,1),16,1.5)))):(k.addObject(new i($V([0,0,0]),2,new g(new b(.75,0,0),new b(1,0,0),new b(1,1,1),32,1/0))),k.addObject(new i($V([1.25,1.25,3]),.5,new g(new b(0,0,.75),new b(0,0,1),new b(.5,.5,1),16,1.5)))),k},this.trace=function(a,b,c,d){var e;return e=new f(b,c,d,a),e.trace()},e=function(){function a(a,b,c){this.line=a,this.refraction=b,this.power=c}return a.prototype.isInside=function(){return 1!==this.refraction},a}(),this.ModuleId={B1:void 0,B2:void 0,B3:void 0,B4:void 0,C1:void 0,C2:void 0,C3:void 0,D1:void 0,D2:void 0,ALT:void 0},"undefined"!=typeof document&&null!==document&&"undefined"!=typeof $&&null!==$&&$(document).ready(function(){var a,b,c,d,e,f;-1!==document.location.toString().indexOf("?")&&(d=document.location.toString().replace(/^.*?\?/,"").replace("#","").split("&"),d.forEach(function(a){var b,c,d;return c=a.split("="),b=c[0],d=c[1],d=void 0===d||"1"===d||"true"===d?!0:!1,ModuleId[b]=d})),f=[];for(b in ModuleId)e=ModuleId[b],a=document.createElement("input"),a.type="checkbox",a.value=1,a.name=b,a.id=b,e&&a.setAttribute("checked","checked"),c=document.createElement("label"),c.setAttribute("class","btn btn-primary"+(e?" active":"")),c.appendChild(a),$(c).data("option",b),c.innerHTML+=b,f.push($("#renderOptions").append(c));return f}),this.initRayConfig=function(){return this.RayConfig={width:800,height:600,illumination:!0,reflection:ModuleId.B1,refraction:ModuleId.B1,antialiasing:ModuleId.B2?4:1,recDepth:20}},initRayConfig(),f=function(){function a(a,b,c,d){this.color=a,this.pixelX=b,this.pixelY=c,this.scene=d}return a.prototype.trace=function(){var a,c,d,e,f=this;return d=this.castRays(RayConfig.antialiasing),console.setRlog(),e=function(a){return f.traceRec(a,new b(0,0,0),RayConfig.recDepth)},c=d.map(function(a){return e(a)}),a=c.map(function(a){return a.toVector()}).reduce(function(a,b){return a.add(b)}).multiply(1/c.length),this.color.setElements(a.elements)},a.prototype.traceRec=function(a,b,c){var d,e,f,g,h,i,j,k,l;if(f=this.scene.firstIntersection(a)){if(i=f[0],h=f[1],d=this.scene.globalAmbient,e=h.reflectionProperties.ambientColor.multiply(d),b=b.add(e),RayConfig.illumination)for(l=this.scene.lights,j=0,k=l.length;k>j;j++)g=l[j],b=b.add(this.illuminate(i,h,a,g));if(0>=c)return b;RayConfig.reflection&&(b=b.add(this.reflectAndRefract(i,h,a,c)))}return b},a.prototype.reflectAndRefract=function(a,c,d,e){var f,g,h,i,j,k;return k=this.specularRays(a,c,d),g=k[0],h=k[1],f=new b(0,0,0),null!=g&&(i=this.traceRec(g,new b(0,0,0),e-1),i=i.multiplyColor(c.reflectionProperties.specularColor),f=f.add(i.multiply(g.power))),null!=h&&(j=this.traceRec(h,new b(0,0,0),e-1),j=j.multiplyColor(c.reflectionProperties.specularColor),f=f.add(j.multiply(h.power))),f},a.prototype.specularRays=function(a,b,c){var d,f,g,h,i,j,k,l,m,n,o,p,q,r,s;if(i=b.norm(a),c.isInside()&&(i=i.multiply(-1)),g=a.subtract(c.line.anchor).toUnitVector(),j=c.refraction,k=c.isInside()?1:b.reflectionProperties.refractionIndex,h=g.dot(i),d=-h,o=g.add(i.multiply(2*d)),1/0===k)return[new e($L(a,o),j,c.power),null];if(n=j/k,s=Math.square(n)*(1-Math.square(d)),s>1)return[new e($L(a,o),j,c.power),null];if(f=Math.sqrt(1-s),q=g.multiply(n).add(i.multiply(n*d-f)),l=Math.square((j*d-k*f)/(j*d+k*f)),m=Math.square((k*d-j*f)/(k*d+j*f)),p=(l+m)/2,r=1-p,!(p>=0&&1>=p&&r>=0&&1>=r))return[new e($L(a,o),j,c.power),null];if(!(p>=0&&1>=p&&r>=0&&1>=r))throw"Invalid state: reflectionPowerRatio: "+p+", refractionPowerRatio: "+r;return[new e($L(a,o),j,c.power*p),new e($L(a,q),k,c.power*r)]},a.prototype.illuminate=function(a,c,d,f){var g,h,i,j,k,l,m,n,o,p,q,r,s,t;return o=c.norm(a),r=d.line.direction,s=f.location.subtract(a).toUnitVector(),t=o.multiply(2).multiply(r.dot(o)).subtract(r).toUnitVector(),this.scene.intersections(new e($L(a,s),d.refraction,1)).length>0?new b(0,0,0):(h=f.intensity.ambient,i=c.reflectionProperties.ambientColor.multiply(h),l=c.reflectionProperties.diffuseColor,g=f.intensity.diffuse*o.dot(s),j=l.multiply(g*f.intensity.diffuse),n=c.reflectionProperties.specularExponent,m=c.reflectionProperties.specularColor,k=Math.pow(t.dot(s),n)/o.dot(s),q=k*g,0>k&&(q=0),p=m.multiply(q),i.add(j).add(p))},a.prototype.castRays=function(a){var b,c,d,f,g=this;return b=this.scene.camera,d=b.width*a,c=b.height*a,function(){f=[];for(var b=1;a>=1?a>=b:b>=a;a>=1?b++:b--)f.push(b);return f}.apply(this).map(function(f){var h;return function(){h=[];for(var b=1;a>=1?a>=b:b>=a;a>=1?b++:b--)h.push(b);return h}.apply(this).map(function(h){var i,j,k;return i=(g.pixelX*a+(f-1)+.5-d/2)/c*b.imagePaneHeight,j=(-g.pixelY*a-(h-1)-.5+c/2)/d*b.imagePaneWidth,k=b.imageCenter.add(b.upDirection.multiply(i)).add(b.rightDirection.multiply(j)).subtract(b.position),new e($L(b.position,k),1,1)})}).reduce(function(a,b){return a.concat(b)})},a}(),g=function(){function a(a,b,c,d,e){this.ambientColor=a,this.diffuseColor=b,this.specularColor=c,this.specularExponent=d,this.refractionIndex=e}return a}(),h=function(){function a(a,b){this.camera=a,this.globalAmbient=b,this.objects=[],this.lights=[]}return a.prototype.addLight=function(a){return this.lights.push(a)},a.prototype.addObject=function(a){return this.objects.push(a)},a.prototype.intersections=function(a){var b,c,d,e,f;for(e=this.objects,f=[],c=0,d=e.length;d>c;c++)b=e[c],b.intersects(a)&&f.push(b);return f},a.prototype.firstIntersection=function(a){var b,c;return b=1/0,c=null,this.objects.forEach(function(d){var e,f;return e=d.intersects(a),e&&b>e&&e>1e-5?(b=e,f=a.line.anchor.add(a.line.direction.multiply(e)),c=[f,d]):void 0}),c},a}(),i=function(){function a(a,b,c){this.center=a,this.radius=b,this.reflectionProperties=c,this.radiusSquared=this.radius*this.radius}return a.prototype.norm=function(a){return a.subtract(this.center).toUnitVector()},a.prototype.intersects=function(a){var b,c,d,e,f,g,h,i,j;return console.setRlog(),f=a.line.anchor,d=a.line.direction,b=this.center,c=b.subtract(f),e=c.dot(c),g=c.dot(d),0>g?!1:(h=e-g*g,h>this.radiusSquared?!1:(j=this.radiusSquared-h,0>j?!1:i=g-Math.sqrt(j)))},a}(),console.setRlog=function(a){return null==a&&(a=.01),this.shoulLog=Math.random()<=a},console.rlog=function(a){return this.shoulLog?console.log(a):void 0},Math.square=function(a){return a*a}}).call(this);
//# sourceMappingURL=./public/out/compiled.min.js.map