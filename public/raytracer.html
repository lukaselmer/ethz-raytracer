<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">

	<!-- read the list of module enabled (for example you can use in your code: "if(ModuleId.B3) { ... }") -->
	<script src="lib/ModuleId.js"></script>
	
	<!-- simple vector and matrix library (see documentation: http://sylvester.jcoglan.com/) -->
	<script src="lib/sylvester.src.js"></script>

	<!-- TGA and OBJ loader for exercise 3 -->
	<script type="text/javascript">
		var waitingForData = 0; // # of asynchronous loading requests in progress (renderer will wait for them to be done)
	</script>
	<script src="lib/read_tga.js"></script>
	<script src="lib/read_obj.js"></script>
	
	<!-- DO NOT change the code BEFORE this point unless you know what you are doing -->
	
	<!-- you can include additional script files here if you need -->
	<!--<script src="src/helpers.js"></script>-->
	<script src="out/compiled.js"></script>
	<!-- ... -->

		
	<!-- DO NOT change the code AFTER this point unless you know what you are doing -->
	<script type="text/javascript">

		var width = RayConfig.width, height = RayConfig.width; // image size

		var canv, ctx, imgData; // canvas
		var imgBuffer; // canvas buffer
		var pixBuffer; // color pixel buffer
		
		var curPixelX = 0, curPixelY = 0; // current pixel to render
		
		// initialization when page loads
		function load() {
            document.getElementById("mainContent").style.width = RayConfig.width + "px";
            document.getElementById("myCanvasDiv").style.width = RayConfig.width + "px";
            document.getElementById("myCanvasDiv").style.height = RayConfig.height + "px";
            document.getElementById("myCanvas").width = RayConfig.width
            document.getElementById("myCanvas").height = RayConfig.height

			canv = document.getElementById("myCanvas");
			ctx = canv.getContext("2d");
			imgData = ctx.createImageData(width,height);
			imgBuffer = imgData.data;
			pixBuffer = new Array();
			
			canv.onclick = function(e) {
				debugPixel(e.offsetX,e.offsetY);
			}
			
			startRendering(); // render the scene
		}
		
		// launch the renderer
		function startRendering() {
			clearBuffer(); // clear current buffer
			curPixelX = 0; curPixelY = 0; // reset next pixel to be rendered
			loadScene(); // load the scene
			refresh();
			setTimeout("render()",0); // render
		}
		
		// reset all the pixel to white color
		function clearBuffer() {
			var curPixel = 0;
			for(curPixelY = 0; curPixelY < height; ++curPixelY) {
				for(curPixelX = 0; curPixelX < width; ++curPixelX) {
					pixBuffer[4*curPixel+0] = 1.0;
					pixBuffer[4*curPixel+1] = 1.0;
					pixBuffer[4*curPixel+2] = 1.0;
					pixBuffer[4*curPixel+3] = 1.0;
					curPixel++;
				}
			}
		}
		
		// update the canvas with currently computed colors
		function refresh() {
			for(var i = 0; i < pixBuffer.length; ++i) {
				imgBuffer[i] = (pixBuffer[i]*255.0);
			}
			ctx.putImageData(imgData,0,0);
		}
		
		// render the new 50 lines of pixels
		function render() {
			if(curPixelY == height) return; // rendering done
			if(waitingForData > 0) { // textures are not loaded yet, wait for them
				console.log("Some data are not loaded yet, waiting for them before starting to render");
				setTimeout("render()",1000);
				return;
			}
		
			var color = Vector.create([0,0,0]);
			var curPixel = curPixelY*width;
			for(var i = 0; i < 50; ++i, ++curPixelY) {
				for(curPixelX = 0; curPixelX < width; ++curPixelX) {
					// compute the color for the current pixel
					trace(color, curPixelX, curPixelY);
				
					// copy the result in the buffer
					pixBuffer[4*curPixel+0] = color.e(1);
					pixBuffer[4*curPixel+1] = color.e(2);
					pixBuffer[4*curPixel+2] = color.e(3);
					pixBuffer[4*curPixel+3] = 1.0;
					curPixel++;
				}
			}
			refresh(); // update screen
			
			// call render as soon as possible to compute next pixel values
			setTimeout("render()",0);
		}
		
		// export the canvas in a PNG file
		function exportPNG() {
			var data = canv.toDataURL("image/png");
			data = data.replace("image/png", "image/octet-stream");
			document.getElementById("exportLink").href = data;
			document.getElementById("exportLink").download = "cg-exN-lukaselmer-moduleid.png";
			document.getElementById("exportLink").click();
		}
		
		function debugPixel(x,y) {
			var color = $V([0,0,0]);
			trace(color, x, y);
			console.log("Pixel ("+x+","+y+"): RGB -> "+color.e(1)+" "+color.e(2)+" "+color.e(3));
		}
		

	</script>

	<style>

	body, button {
		font-family: 'Verdana', 'Geneva', sans-serif;
		font-size: 14pt;
	}

	</style>

</head>

<body onload="load()">
    <div><button onclick="exportPNG()" style="width: 396px; height: 40px;">Export</button></div>

	<div id="mainContent" style="margin-left: auto; margin-right: auto;">
		<div id="myUI" style="text-align:center;">
			<button onclick="startRendering()" style="width: 396px; height: 40px;">Render</button>
			
			<button onclick="exportPNG()" style="width: 396px; height: 40px;">Export</button>
			<!-- hidden link needed to export the image as a PNG -->
			<a id="exportLink" download="" href=""></a>
		</div>

		<div id="myCanvasDiv" style="border: 1px solid black; margin-top: 10px;">
			<canvas id="myCanvas"></canvas>
		</div>
		
	</div>

</body>
</html>